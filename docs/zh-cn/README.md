# 流程介绍

     定义三种流程的type：1正常，2场内，3无牌，4优惠信息

### 车牌正常识别出口扫码支付流程

    * 当通道出口相机识别到车牌号并查询到车辆信息后通过tcp协议传输到服务端
        * 服务端IP：端口号：
            106.12.175.226:9506
        * 传输格式：
            type1,asd23asd,1,晋A597GA,12.00,1,0.00,0.00,2020-02-15 09:22:23,2020-02-20 09:22:23;
        * 格式说明：流程类型，随机码，通道ID，车牌号，金额，优惠券ID，抵扣，优惠,入场时间，出场时间
    * 当用户扫码支付完成以后服务端通过tcp把支付信息传给客户端并让开杆
        * 服务端会根据支付信息中的通道ID查询当前tcp的连接fd，并发送信息
        * 传输格式：
            type1,asdf23asd,1,12.00,晋A597GA,kaigan,wechat/alipay;
        * 格式说明：流程类型，随机码，通道ID，付款金额，车牌号，开杆指令，支付方式
        * 客户端根据返回金额判断付款金额与应付金额是否一致
    * 如果客户端已开杆需要通过tcp通知服务端已开，否则服务端会一直发送开杆指令
        * 传输格式：
            type1,asd23asd,1,yikai;
        * 格式说明：通道ID，随机码，已开回复
        * 当服务端收到已开回复时会停止向客户端发送开杆指令，支付结束

### 场内扫码支付流程
    * 用户扫码以后在界面中输入车牌号点击查询
        * 服务端主动向客户端发送查询信息
        * 传输格式：
            type2,asd23asd,1,晋A597GA;
        * 格式说明：流程类型，随机码，停车场ID，车牌号
        * 返回格式：
            type2,asd23asd,1,晋A597GA,type2_ok;
        * 格式说明：流程类型，随机码，停车场ID，车牌号，已处理返回标识
    * 客户端收到信息后就走上面的车牌正常出场流程不同的是用户支付完以后服务端
    不会向客户端发送`kaigan`这个指令,同时把`type1`改成`type2`
    
### 无牌车入场流程(唯一码根据微信和支付宝获取)
    * 用户通过微信或者支付宝扫入口码获取到唯一码
    * 服务端把唯一码和生成的临时车牌号传给客户端
    * 传输格式：
        type3,asd23asd,1,asdf23snsd4,晋A597GA,kaigan;
    * 格式说明：流程类型，随机码，入口通道ID，唯一码，临时车牌号,开杆标识
    * 客户端收到信息后开杆让车入场同时返回信息给服务端存储
    * 返回格式：
        type3,asdf23asd,1,yikai_in/no,asdfsdfsasd,L232323;  
    * 格式说明：流程类型，随机码，通道ID，已开杆入场标识,服务端传过去的随机码（防止数据混淆的识别标识）
### 无牌车出场流程
    * 用户扫码服务端获取到唯一码，然后从redis中取出唯一码对应的车牌号
    * 把车牌号传输给客户端，等客户端计算出结果后按正常车辆出场的格式传给服务端
    * 服务端检测出客户端已经计算出结果后就会跳转到对应的通道口的支付页面
    * 传输格式：
        type3,audi23as,1,asdf23saf,晋A597GA;
    * 格式说明：流程类型，随机，通道ID，唯一码，车牌号
    * 客户端收到信息后就走上面的车牌正常出场流程,同时把`type1`改成`type3`
### 优惠信息推送通知格式
    *传输格式：
        type4,asdf23r,晋A2345,2,2020-03-28,2020-03-28,1;
    *格式说明：流程类型，随机码，车牌号，免费时间数（小时），有效开始时间，截止时间,优惠券ID
    *返回格式：
        type4,asdf23r,晋A2345,1,youhui_ok;
    *格式说明：流程类型，随机码，车牌号，优惠券ID，已处理返回标识

      

